(function(){"use strict";var e={6284:function(e,t,o){var a=o(5130),n=o(6768);function r(e,t,o,a,r,s){const l=(0,n.g2)("router-view");return(0,n.uX)(),(0,n.Wv)(l)}var s={},l=o(1241);const i=(0,l.A)(s,[["render",r]]);var c=i,u=o(1387);const d={class:"container welcome"},m={key:0},h={class:"change-form"},p={key:1},g={class:"change-form"};function w(e,t,o,a,r,s){const l=(0,n.g2)("LoginForm"),i=(0,n.g2)("SignupForm");return(0,n.uX)(),(0,n.CE)("div",d,[t[6]||(t[6]=(0,n.Lk)("p",null,"ようこそ！",-1)),r.shouldShowLoginForm?((0,n.uX)(),(0,n.CE)("div",m,[(0,n.bF)(l,{onRedirectToChatRoom:s.redirectToChatRoom},null,8,["onRedirectToChatRoom"]),(0,n.Lk)("p",h,[t[2]||(t[2]=(0,n.eW)("初めての方は")),(0,n.Lk)("span",{onClick:t[0]||(t[0]=e=>r.shouldShowLoginForm=!1)},"こちら"),t[3]||(t[3]=(0,n.eW)("をクリック"))])])):(0,n.Q3)("",!0),r.shouldShowLoginForm?(0,n.Q3)("",!0):((0,n.uX)(),(0,n.CE)("div",p,[(0,n.bF)(i,{onRedirectToChatRoom:s.redirectToChatRoom},null,8,["onRedirectToChatRoom"]),(0,n.Lk)("p",g,[t[4]||(t[4]=(0,n.eW)("アカウントをお持ちの方は")),(0,n.Lk)("span",{onClick:t[1]||(t[1]=e=>r.shouldShowLoginForm=!0)},"こちら"),t[5]||(t[5]=(0,n.eW)("をクリック"))])]))])}o(4114);var v=o(4232);const f={class:"error"};function k(e,t,o,r,s,l){return(0,n.uX)(),(0,n.CE)("div",null,[t[4]||(t[4]=(0,n.Lk)("h2",null,"ログイン",-1)),(0,n.Lk)("form",{onSubmit:t[2]||(t[2]=(0,a.D$)(((...e)=>l.login&&l.login(...e)),["prevent"]))},[(0,n.bo)((0,n.Lk)("input",{type:"email",required:"",placeholder:"メールアドレス","onUpdate:modelValue":t[0]||(t[0]=e=>s.email=e)},null,512),[[a.Jo,s.email]]),(0,n.bo)((0,n.Lk)("input",{type:"password",required:"",placeholder:"パスワード","onUpdate:modelValue":t[1]||(t[1]=e=>s.password=e)},null,512),[[a.Jo,s.password]]),(0,n.Lk)("div",f,(0,v.v_)(s.error),1),t[3]||(t[3]=(0,n.Lk)("button",null,"ログインする",-1))],32)])}var b=o(4373);const C=(e,t)=>{window.localStorage.setItem("access-token",e["access-token"]),window.localStorage.setItem("client",e.client),window.localStorage.setItem("uid",e.uid),window.localStorage.setItem("name",t)};var S=C,L={emits:["redirectToChatRoom"],data(){return{email:"",password:"",error:null}},methods:{async login(){try{this.error=null;const e=await b.A.post("https://live-chat-app-a022a20a842b.herokuapp.com/auth/sign_in",{email:this.email,password:this.password});if(!e)throw new Error("メールアドレスかパスワードが違います");return this.error||(S(e.headers,e.data.data.name),this.$emit("redirectToChatRoom")),console.log({res:e}),e}catch(pe){console.log({error:pe}),this.error="メールアドレスかパスワードが違います"}}}};const y=(0,l.A)(L,[["render",k]]);var I=y;const _={class:"error"};function E(e,t,o,r,s,l){return(0,n.uX)(),(0,n.CE)("div",null,[t[6]||(t[6]=(0,n.Lk)("h2",null,"アカウントを登録",-1)),(0,n.Lk)("form",{onSubmit:t[4]||(t[4]=(0,a.D$)(((...e)=>l.signUp&&l.signUp(...e)),["prevent"]))},[(0,n.bo)((0,n.Lk)("input",{type:"text",required:"",placeholder:"名前","onUpdate:modelValue":t[0]||(t[0]=e=>s.name=e)},null,512),[[a.Jo,s.name]]),(0,n.bo)((0,n.Lk)("input",{type:"email",required:"",placeholder:"メールアドレス","onUpdate:modelValue":t[1]||(t[1]=e=>s.email=e)},null,512),[[a.Jo,s.email]]),(0,n.bo)((0,n.Lk)("input",{type:"password",required:"",placeholder:"パスワード","onUpdate:modelValue":t[2]||(t[2]=e=>s.password=e)},null,512),[[a.Jo,s.password]]),(0,n.bo)((0,n.Lk)("input",{type:"password",required:"",placeholder:"パスワード（確認用）","onUpdate:modelValue":t[3]||(t[3]=e=>s.passwordConfirmation=e)},null,512),[[a.Jo,s.passwordConfirmation]]),(0,n.Lk)("div",_,(0,v.v_)(s.error),1),t[5]||(t[5]=(0,n.Lk)("button",null,"登録する",-1))],32)])}var A={emits:["redirectToChatRoom"],data(){return{name:"",email:"",password:"",passwordConfirmation:"",error:null}},methods:{async signUp(){this.error=null;try{const e=await b.A.post("https://live-chat-app-a022a20a842b.herokuapp.com/auth",{name:this.name,email:this.email,password:this.password,password_confirmation:this.passwordConfirmation});if(!e)throw new Error("アカウントを登録できませんでした");return this.error||(S(e.headers,e.data.data.name),this.$emit("redirectToChatRoom")),console.log({res:e}),e}catch(pe){this.error="アカウントを登録できませんでした"}}}};const R=(0,l.A)(A,[["render",E]]);var T=R,F={components:{SignupForm:T,LoginForm:I},data(){return{shouldShowLoginForm:!1}},methods:{redirectToChatRoom(){this.$router.push({name:"ChatRoom"})}}};const W=(0,l.A)(F,[["render",w]]);var $=W;const O={class:"container"};function X(e,t,o,a,r,s){const l=(0,n.g2)("AppNavbar"),i=(0,n.g2)("ChatWindow"),c=(0,n.g2)("NewChatForm");return(0,n.uX)(),(0,n.CE)("div",O,[(0,n.bF)(l),(0,n.bF)(i,{onConnectCable:s.connectCable,messages:s.formattedMessages,ref:"chatWindow"},null,8,["onConnectCable","messages"]),(0,n.bF)(c,{onConnectCable:s.connectCable},null,8,["onConnectCable"])])}o(8111),o(1701);const j={class:"name"},U={class:"email"},M={class:"error"};function P(e,t,o,a,r,s){return(0,n.uX)(),(0,n.CE)("nav",null,[(0,n.Lk)("div",null,[(0,n.Lk)("p",null,[t[1]||(t[1]=(0,n.eW)("こんにちは、")),(0,n.Lk)("span",j,(0,v.v_)(r.name),1),t[2]||(t[2]=(0,n.eW)("さん"))]),(0,n.Lk)("p",U,"現在、 "+(0,v.v_)(r.email)+" でログイン中です",1),(0,n.Lk)("div",M,(0,v.v_)(r.error),1)]),(0,n.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>s.logout&&s.logout(...e))},"ログアウト")])}const q=()=>{window.localStorage.removeItem("uid"),window.localStorage.removeItem("access-token"),window.localStorage.removeItem("client"),window.localStorage.removeItem("name")};var x=q,J={data(){return{name:window.localStorage.getItem("name"),email:window.localStorage.getItem("uid"),error:null}},methods:{async logout(){this.error=null;try{const e=await b.A.delete("https://live-chat-app-a022a20a842b.herokuapp.com/auth/sign_out",{headers:{uid:this.email,"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});return e||new Error("ログアウトできませんでした"),this.error||(console.log("ログアウトしました"),x(),this.$router.push({name:"WelcomePage"})),e}catch(pe){this.error="ログアウトできませんでした"}}}};const V=(0,l.A)(J,[["render",P],["__scopeId","data-v-ffbfa922"]]);var D=V;const K={class:"chat-window"},N={key:0,class:"messages",ref:"messages"},Q={class:"name"},B=["onDblclick"],H={key:0,class:"heart-container"},Y={class:"heart-count"},z={class:"created-at"};function G(e,t,o,a,r,s){const l=(0,n.g2)("font-awesome-icon");return(0,n.uX)(),(0,n.CE)("div",K,[o.messages?((0,n.uX)(),(0,n.CE)("div",N,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(o.messages,(e=>((0,n.uX)(),(0,n.CE)("ul",{key:e.id},[(0,n.Lk)("li",{class:(0,v.C4)({received:e.email!==r.uid,sent:e.email===r.uid})},[(0,n.Lk)("span",Q,(0,v.v_)(e.name),1),(0,n.Lk)("div",{class:"message",onDblclick:t=>s.handleLike(e)},[(0,n.eW)((0,v.v_)(e.content)+" ",1),e.likes.length?((0,n.uX)(),(0,n.CE)("div",H,[(0,n.bF)(l,{icon:"heart",class:"heart"}),(0,n.Lk)("span",Y,(0,v.v_)(e.likes.length),1)])):(0,n.Q3)("",!0)],40,B),(0,n.Lk)("span",z,(0,v.v_)(e.created_at)+"前",1)],2)])))),128))],512)):(0,n.Q3)("",!0)])}var Z={emits:["connectCable"],props:["messages"],data(){return{uid:localStorage.getItem("uid")}},methods:{handleLike(e){for(let t=0;t<e.likes.length;t++){const o=e.likes[t];if(o.email===this.uid)return void this.deleteLike(o.id)}this.createLike(e.id)},async createLike(e){try{const t=await b.A.post(`https://live-chat-app-a022a20a842b.herokuapp.com/messages/${e}/likes`,{},{headers:{uid:this.uid,"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});t||new Error("いいねできませんでした"),this.$emit("connectCable")}catch(pe){console.log(pe)}},async deleteLike(e){try{const t=await b.A.delete(`https://live-chat-app-a022a20a842b.herokuapp.com/likes/${e}`,{headers:{uid:this.uid,"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});t||new Error("いいねを削除できませんでした"),this.$emit("connectCable")}catch(pe){console.log(pe)}},scrollToBottom(){const e=this.$refs.messages;e.scrollTop=e.scrollHeight}}};const ee=(0,l.A)(Z,[["render",G],["__scopeId","data-v-540a8658"]]);var te=ee;function oe(e,t,o,r,s,l){return(0,n.uX)(),(0,n.CE)("form",null,[(0,n.bo)((0,n.Lk)("textarea",{placeholder:"メッセージを入力してEnterを押してください","onUpdate:modelValue":t[0]||(t[0]=e=>s.message=e),onKeypress:t[1]||(t[1]=(0,a.jR)((0,a.D$)(((...e)=>l.handleSubmit&&l.handleSubmit(...e)),["prevent"]),["enter"]))},null,544),[[a.Jo,s.message]])])}var ae={emits:["connectCable"],data(){return{message:""}},methods:{handleSubmit(){this.$emit("connectCable",this.message),this.message=""}}};const ne=(0,l.A)(ae,[["render",oe],["__scopeId","data-v-0f9c553c"]]);var re=ne,se=o(2051),le=o.n(se),ie=o(3855),ce=o(5897),ue={components:{AppNavbar:D,ChatWindow:te,NewChatForm:re},data(){return{messages:[]}},computed:{formattedMessages(){return this.messages.length?this.messages.map((e=>{let t=(0,ie.m)(new Date(e.created_at),{locale:ce.ja});return{...e,created_at:t}})):[]}},methods:{async getMessages(){try{const e=await b.A.get("https://live-chat-app-a022a20a842b.herokuapp.com/messages",{headers:{uid:window.localStorage.getItem("uid"),"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});e||new Error("メッセージ一覧を取得できませんでした"),this.messages=e.data}catch(e){console.log(e)}},connectCable(e){this.messageChannel.perform("receive",{message:e,email:window.localStorage.getItem("uid")})}},mounted(){const e=le().createConsumer("ws://live-chat-app-a022a20a842b.herokuapp.com/cable");this.messageChannel=e.subscriptions.create("RoomChannel",{connected:()=>{this.getMessages().then((()=>{this.$refs.chatWindow.scrollToBottom()}))},received:()=>{this.getMessages().then((()=>{this.$refs.chatWindow.scrollToBottom()}))}})},beforeUnmount(){this.messageChannel.unsubscribe()}};const de=(0,l.A)(ue,[["render",X]]);var me=de,he=o(144);const pe=(0,he.KR)(null),ge=async()=>{pe.value=null;const e=window.localStorage.getItem("uid"),t=window.localStorage.getItem("client"),o=window.localStorage.getItem("access-token");try{const a=await b.A.get("https://live-chat-app-a022a20a842b.herokuapp.com/auth/validate_token",{headers:{uid:e,"access-token":o,client:t}});if(!a)throw new Error("認証に失敗しました");return a}catch(a){pe.value="認証に失敗しました",x()}},we=()=>({error:pe,validate:ge});var ve=we;const{error:fe,validate:ke}=ve(),be=async(e,t,o)=>{const a=window.localStorage.getItem("uid"),n=window.localStorage.getItem("client"),r=window.localStorage.getItem("access-token");if(!a||!n||!r)return console.log("ログインしていません"),void o({name:"WelcomePage"});await ke(),fe.value?(console.log("認証に失敗しました"),o({name:"WelcomePage"})):o()},Ce=async(e,t,o)=>{const a=window.localStorage.getItem("uid"),n=window.localStorage.getItem("client"),r=window.localStorage.getItem("access-token");a||n||r?(await ke(),fe.value?o():o({name:"ChatRoom"})):o()},Se=[{path:"/",name:"WelcomePage",component:$,beforeEnter:Ce},{path:"/chatroom",name:"ChatRoom",component:me,beforeEnter:be}],Le=(0,u.aE)({history:(0,u.LA)("/"),routes:Se});var ye=Le,Ie=o(292),_e=o(8950),Ee=o(2353);_e.Yv.add(Ee.qcK),b.A.defaults.headers.get["Content-Type"]="application/json",b.A.defaults.headers.get["Access-Control-Allow-Origin"]="*",(0,a.Ef)(c).use(ye).component("font-awesome-icon",Ie.gc).mount("#app")}},t={};function o(a){var n=t[a];if(void 0!==n)return n.exports;var r=t[a]={exports:{}};return e[a].call(r.exports,r,r.exports,o),r.exports}o.m=e,function(){var e=[];o.O=function(t,a,n,r){if(!a){var s=1/0;for(u=0;u<e.length;u++){a=e[u][0],n=e[u][1],r=e[u][2];for(var l=!0,i=0;i<a.length;i++)(!1&r||s>=r)&&Object.keys(o.O).every((function(e){return o.O[e](a[i])}))?a.splice(i--,1):(l=!1,r<s&&(s=r));if(l){e.splice(u--,1);var c=n();void 0!==c&&(t=c)}}return t}r=r||0;for(var u=e.length;u>0&&e[u-1][2]>r;u--)e[u]=e[u-1];e[u]=[a,n,r]}}(),function(){o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,{a:t}),t}}(),function(){o.d=function(e,t){for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){o.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};o.O.j=function(t){return 0===e[t]};var t=function(t,a){var n,r,s=a[0],l=a[1],i=a[2],c=0;if(s.some((function(t){return 0!==e[t]}))){for(n in l)o.o(l,n)&&(o.m[n]=l[n]);if(i)var u=i(o)}for(t&&t(a);c<s.length;c++)r=s[c],o.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return o.O(u)},a=self["webpackChunklive_chat_vuejs"]=self["webpackChunklive_chat_vuejs"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=o.O(void 0,[504],(function(){return o(6284)}));a=o.O(a)})();
//# sourceMappingURL=app.e1173b5c.js.map