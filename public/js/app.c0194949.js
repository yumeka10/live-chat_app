(function(){"use strict";var e={3420:function(e,o,t){var n=t(5130),a=t(6768);function r(e,o,t,n,r,s){const l=(0,a.g2)("router-view");return(0,a.uX)(),(0,a.Wv)(l)}var s={},l=t(1241);const i=(0,l.A)(s,[["render",r]]);var c=i,d=t(1387);const u={class:"container welcome"},m={key:0},h={class:"change-form"},g={key:1},w={class:"change-form"};function p(e,o,t,n,r,s){const l=(0,a.g2)("LoginForm"),i=(0,a.g2)("SignupForm");return(0,a.uX)(),(0,a.CE)("div",u,[o[6]||(o[6]=(0,a.Lk)("p",null,"ようこそ！",-1)),r.shouldShowLoginForm?((0,a.uX)(),(0,a.CE)("div",m,[(0,a.bF)(l,{onRedirectToChatRoom:s.redirectToChatRoom},null,8,["onRedirectToChatRoom"]),(0,a.Lk)("p",h,[o[2]||(o[2]=(0,a.eW)("初めての方は")),(0,a.Lk)("span",{onClick:o[0]||(o[0]=e=>r.shouldShowLoginForm=!1)},"こちら"),o[3]||(o[3]=(0,a.eW)("をクリック"))])])):(0,a.Q3)("",!0),r.shouldShowLoginForm?(0,a.Q3)("",!0):((0,a.uX)(),(0,a.CE)("div",g,[(0,a.bF)(i,{onRedirectToChatRoom:s.redirectToChatRoom},null,8,["onRedirectToChatRoom"]),(0,a.Lk)("p",w,[o[4]||(o[4]=(0,a.eW)("アカウントをお持ちの方は")),(0,a.Lk)("span",{onClick:o[1]||(o[1]=e=>r.shouldShowLoginForm=!0)},"こちら"),o[5]||(o[5]=(0,a.eW)("をクリック"))])]))])}t(4114);var v=t(4232);const f={class:"error"};function k(e,o,t,r,s,l){return(0,a.uX)(),(0,a.CE)("div",null,[o[4]||(o[4]=(0,a.Lk)("h2",null,"ログイン",-1)),(0,a.Lk)("form",{onSubmit:o[2]||(o[2]=(0,n.D$)(((...e)=>l.login&&l.login(...e)),["prevent"]))},[(0,a.bo)((0,a.Lk)("input",{type:"email",required:"",placeholder:"メールアドレス","onUpdate:modelValue":o[0]||(o[0]=e=>s.email=e)},null,512),[[n.Jo,s.email]]),(0,a.bo)((0,a.Lk)("input",{type:"password",required:"",placeholder:"パスワード","onUpdate:modelValue":o[1]||(o[1]=e=>s.password=e)},null,512),[[n.Jo,s.password]]),(0,a.Lk)("div",f,(0,v.v_)(s.error),1),o[3]||(o[3]=(0,a.Lk)("button",null,"ログインする",-1))],32)])}var C=t(4373);const b=(e,o)=>{window.localStorage.setItem("access-token",e["access-token"]),window.localStorage.setItem("client",e.client),window.localStorage.setItem("uid",e.uid),window.localStorage.setItem("name",o)};var S=b,L={emits:["redirectToChatRoom"],data(){return{email:"",password:"",error:null}},methods:{async login(){try{this.error=null;const e=await C.A.post("http://localhost:3000/auth/sign_in",{email:this.email,password:this.password});if(!e)throw new Error("メールアドレスかパスワードが違います");return this.error||(S(e.headers,e.data.data.name),this.$emit("redirectToChatRoom")),console.log({res:e}),e}catch(ge){console.log({error:ge}),this.error="メールアドレスかパスワードが違います"}}}};const y=(0,l.A)(L,[["render",k]]);var I=y;const _={class:"error"};function E(e,o,t,r,s,l){return(0,a.uX)(),(0,a.CE)("div",null,[o[6]||(o[6]=(0,a.Lk)("h2",null,"アカウントを登録",-1)),(0,a.Lk)("form",{onSubmit:o[4]||(o[4]=(0,n.D$)(((...e)=>l.signUp&&l.signUp(...e)),["prevent"]))},[(0,a.bo)((0,a.Lk)("input",{type:"text",required:"",placeholder:"名前","onUpdate:modelValue":o[0]||(o[0]=e=>s.name=e)},null,512),[[n.Jo,s.name]]),(0,a.bo)((0,a.Lk)("input",{type:"email",required:"",placeholder:"メールアドレス","onUpdate:modelValue":o[1]||(o[1]=e=>s.email=e)},null,512),[[n.Jo,s.email]]),(0,a.bo)((0,a.Lk)("input",{type:"password",required:"",placeholder:"パスワード","onUpdate:modelValue":o[2]||(o[2]=e=>s.password=e)},null,512),[[n.Jo,s.password]]),(0,a.bo)((0,a.Lk)("input",{type:"password",required:"",placeholder:"パスワード（確認用）","onUpdate:modelValue":o[3]||(o[3]=e=>s.passwordConfirmation=e)},null,512),[[n.Jo,s.passwordConfirmation]]),(0,a.Lk)("div",_,(0,v.v_)(s.error),1),o[5]||(o[5]=(0,a.Lk)("button",null,"登録する",-1))],32)])}var A={emits:["redirectToChatRoom"],data(){return{name:"",email:"",password:"",passwordConfirmation:"",error:null}},methods:{async signUp(){this.error=null;try{const e=await C.A.post("http://localhost:3000/auth",{name:this.name,email:this.email,password:this.password,password_confirmation:this.passwordConfirmation});if(!e)throw new Error("アカウントを登録できませんでした");return this.error||(S(e.headers,e.data.data.name),this.$emit("redirectToChatRoom")),console.log({res:e}),e}catch(ge){this.error="アカウントを登録できませんでした"}}}};const R=(0,l.A)(A,[["render",E]]);var T=R,F={components:{SignupForm:T,LoginForm:I},data(){return{shouldShowLoginForm:!1}},methods:{redirectToChatRoom(){this.$router.push({name:"ChatRoom"})}}};const W=(0,l.A)(F,[["render",p]]);var $=W;const O={class:"container"};function X(e,o,t,n,r,s){const l=(0,a.g2)("AppNavbar"),i=(0,a.g2)("ChatWindow"),c=(0,a.g2)("NewChatForm");return(0,a.uX)(),(0,a.CE)("div",O,[(0,a.bF)(l),(0,a.bF)(i,{onConnectCable:s.connectCable,messages:s.formattedMessages,ref:"chatWindow"},null,8,["onConnectCable","messages"]),(0,a.bF)(c,{onConnectCable:s.connectCable},null,8,["onConnectCable"])])}t(8111),t(1701);const j={class:"name"},U={class:"email"},M={class:"error"};function P(e,o,t,n,r,s){return(0,a.uX)(),(0,a.CE)("nav",null,[(0,a.Lk)("div",null,[(0,a.Lk)("p",null,[o[1]||(o[1]=(0,a.eW)("こんにちは、")),(0,a.Lk)("span",j,(0,v.v_)(r.name),1),o[2]||(o[2]=(0,a.eW)("さん"))]),(0,a.Lk)("p",U,"現在、 "+(0,v.v_)(r.email)+" でログイン中です",1),(0,a.Lk)("div",M,(0,v.v_)(r.error),1)]),(0,a.Lk)("button",{onClick:o[0]||(o[0]=(...e)=>s.logout&&s.logout(...e))},"ログアウト")])}const q=()=>{window.localStorage.removeItem("uid"),window.localStorage.removeItem("access-token"),window.localStorage.removeItem("client"),window.localStorage.removeItem("name")};var x=q,J={data(){return{name:window.localStorage.getItem("name"),email:window.localStorage.getItem("uid"),error:null}},methods:{async logout(){this.error=null;try{const e=await C.A.delete("http://localhost:3000/auth/sign_out",{headers:{uid:this.email,"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});return e||new Error("ログアウトできませんでした"),this.error||(console.log("ログアウトしました"),x(),this.$router.push({name:"WelcomePage"})),e}catch(ge){this.error="ログアウトできませんでした"}}}};const V=(0,l.A)(J,[["render",P],["__scopeId","data-v-3a3b4edd"]]);var D=V;const K={class:"chat-window"},N={key:0,class:"messages",ref:"messages"},Q={class:"name"},B=["onDblclick"],H={key:0,class:"heart-container"},Y={class:"heart-count"},z={class:"created-at"};function G(e,o,t,n,r,s){const l=(0,a.g2)("font-awesome-icon");return(0,a.uX)(),(0,a.CE)("div",K,[t.messages?((0,a.uX)(),(0,a.CE)("div",N,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(t.messages,(e=>((0,a.uX)(),(0,a.CE)("ul",{key:e.id},[(0,a.Lk)("li",{class:(0,v.C4)({received:e.email!==r.uid,sent:e.email===r.uid})},[(0,a.Lk)("span",Q,(0,v.v_)(e.name),1),(0,a.Lk)("div",{class:"message",onDblclick:o=>s.handleLike(e)},[(0,a.eW)((0,v.v_)(e.content)+" ",1),e.likes.length?((0,a.uX)(),(0,a.CE)("div",H,[(0,a.bF)(l,{icon:"heart",class:"heart"}),(0,a.Lk)("span",Y,(0,v.v_)(e.likes.length),1)])):(0,a.Q3)("",!0)],40,B),(0,a.Lk)("span",z,(0,v.v_)(e.created_at)+"前",1)],2)])))),128))],512)):(0,a.Q3)("",!0)])}var Z={emits:["connectCable"],props:["messages"],data(){return{uid:localStorage.getItem("uid")}},methods:{handleLike(e){for(let o=0;o<e.likes.length;o++){const t=e.likes[o];if(t.email===this.uid)return void this.deleteLike(t.id)}this.createLike(e.id)},async createLike(e){try{const o=await C.A.post(`http://localhost:3000/messages/${e}/likes`,{},{headers:{uid:this.uid,"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});o||new Error("いいねできませんでした"),this.$emit("connectCable")}catch(ge){console.log(ge)}},async deleteLike(e){try{const o=await C.A.delete(`http://localhost:3000/likes/${e}`,{headers:{uid:this.uid,"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});o||new Error("いいねを削除できませんでした"),this.$emit("connectCable")}catch(ge){console.log(ge)}},scrollToBottom(){const e=this.$refs.messages;e.scrollTop=e.scrollHeight}}};const ee=(0,l.A)(Z,[["render",G],["__scopeId","data-v-c9037910"]]);var oe=ee;function te(e,o,t,r,s,l){return(0,a.uX)(),(0,a.CE)("form",null,[(0,a.bo)((0,a.Lk)("textarea",{placeholder:"メッセージを入力してEnterを押してください","onUpdate:modelValue":o[0]||(o[0]=e=>s.message=e),onKeypress:o[1]||(o[1]=(0,n.jR)((0,n.D$)(((...e)=>l.handleSubmit&&l.handleSubmit(...e)),["prevent"]),["enter"]))},null,544),[[n.Jo,s.message]])])}var ne={emits:["connectCable"],data(){return{message:""}},methods:{handleSubmit(){this.$emit("connectCable",this.message),this.message=""}}};const ae=(0,l.A)(ne,[["render",te],["__scopeId","data-v-0f9c553c"]]);var re=ae,se=t(2051),le=t.n(se),ie=t(3855),ce=t(5897),de={components:{AppNavbar:D,ChatWindow:oe,NewChatForm:re},data(){return{messages:[]}},computed:{formattedMessages(){return this.messages.length?this.messages.map((e=>{let o=(0,ie.m)(new Date(e.created_at),{locale:ce.ja});return{...e,created_at:o}})):[]}},methods:{async getMessages(){try{const e=await C.A.get("http://localhost:3000/messages",{headers:{uid:window.localStorage.getItem("uid"),"access-token":window.localStorage.getItem("access-token"),client:window.localStorage.getItem("client")}});e||new Error("メッセージ一覧を取得できませんでした"),this.messages=e.data}catch(e){console.log(e)}},connectCable(e){this.messageChannel.perform("receive",{message:e,email:window.localStorage.getItem("uid")})}},mounted(){const e=le().createConsumer("ws://localhost:3000/cable");this.messageChannel=e.subscriptions.create("RoomChannel",{connected:()=>{this.getMessages().then((()=>{this.$refs.chatWindow.scrollToBottom()}))},received:()=>{this.getMessages().then((()=>{this.$refs.chatWindow.scrollToBottom()}))}})},beforeUnmount(){this.messageChannel.unsubscribe()}};const ue=(0,l.A)(de,[["render",X]]);var me=ue,he=t(144);const ge=(0,he.KR)(null),we=async()=>{ge.value=null;const e=window.localStorage.getItem("uid"),o=window.localStorage.getItem("client"),t=window.localStorage.getItem("access-token");try{const n=await C.A.get("http://localhost:3000/auth/validate_token",{headers:{uid:e,"access-token":t,client:o}});if(!n)throw new Error("認証に失敗しました");return n}catch(n){ge.value="認証に失敗しました",x()}},pe=()=>({error:ge,validate:we});var ve=pe;const{error:fe,validate:ke}=ve(),Ce=async(e,o,t)=>{const n=window.localStorage.getItem("uid"),a=window.localStorage.getItem("client"),r=window.localStorage.getItem("access-token");if(!n||!a||!r)return console.log("ログインしていません"),void t({name:"WelcomePage"});await ke(),fe.value?(console.log("認証に失敗しました"),t({name:"WelcomePage"})):t()},be=async(e,o,t)=>{const n=window.localStorage.getItem("uid"),a=window.localStorage.getItem("client"),r=window.localStorage.getItem("access-token");n||a||r?(await ke(),fe.value?t():t({name:"ChatRoom"})):t()},Se=[{path:"/",name:"WelcomePage",component:$,beforeEnter:be},{path:"/chatroom",name:"ChatRoom",component:me,beforeEnter:Ce}],Le=(0,d.aE)({history:(0,d.LA)("/"),routes:Se});var ye=Le,Ie=t(292),_e=t(8950),Ee=t(2353);_e.Yv.add(Ee.qcK),C.A.defaults.headers.common["Content-Type"]="application/json",C.A.defaults.headers.common["Access-Control-Allow-Origin"]="*",(0,n.Ef)(c).use(ye).component("font-awesome-icon",Ie.gc).mount("#app")}},o={};function t(n){var a=o[n];if(void 0!==a)return a.exports;var r=o[n]={exports:{}};return e[n].call(r.exports,r,r.exports,t),r.exports}t.m=e,function(){var e=[];t.O=function(o,n,a,r){if(!n){var s=1/0;for(d=0;d<e.length;d++){n=e[d][0],a=e[d][1],r=e[d][2];for(var l=!0,i=0;i<n.length;i++)(!1&r||s>=r)&&Object.keys(t.O).every((function(e){return t.O[e](n[i])}))?n.splice(i--,1):(l=!1,r<s&&(s=r));if(l){e.splice(d--,1);var c=a();void 0!==c&&(o=c)}}return o}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[n,a,r]}}(),function(){t.n=function(e){var o=e&&e.__esModule?function(){return e["default"]}:function(){return e};return t.d(o,{a:o}),o}}(),function(){t.d=function(e,o){for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)}}(),function(){t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};t.O.j=function(o){return 0===e[o]};var o=function(o,n){var a,r,s=n[0],l=n[1],i=n[2],c=0;if(s.some((function(o){return 0!==e[o]}))){for(a in l)t.o(l,a)&&(t.m[a]=l[a]);if(i)var d=i(t)}for(o&&o(n);c<s.length;c++)r=s[c],t.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return t.O(d)},n=self["webpackChunklive_chat_vuejs"]=self["webpackChunklive_chat_vuejs"]||[];n.forEach(o.bind(null,0)),n.push=o.bind(null,n.push.bind(n))}();var n=t.O(void 0,[504],(function(){return t(3420)}));n=t.O(n)})();
//# sourceMappingURL=app.c0194949.js.map